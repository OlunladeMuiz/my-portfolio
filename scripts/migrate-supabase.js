/*
Migration script that creates `submissions` table and enables RLS. This script connects
using the DATABASE_URL environment variable (Postgres connection string). Use a secure
connection string (do not commit to repo).

Usage:
DATABASE_URL=postgres://<user>:<pass>@dbhost:5432/postgres node scripts/migrate-supabase.js
*/

const { Client } = require('pg');

const DATABASE_URL = process.env.DATABASE_URL;
if (!DATABASE_URL) {
  console.error('Please set DATABASE_URL to run this migration script.');
  process.exit(1);
}

const sql = `
create table if not exists public.submissions (
  id bigint generated by default as identity primary key,
  name text not null,
  email text not null,
  subject text not null,
  message text not null,
  received_at timestamptz not null default now()
);

alter table public.submissions enable row level security;

-- Drop any open policies
DO $$ BEGIN
  IF EXISTS (SELECT 1 FROM pg_policies WHERE polname = 'allow_public_insert' AND polrelid = 'public.submissions'::regclass) THEN
    EXECUTE 'drop policy if exists allow_public_insert on public.submissions';
  END IF;
END$$;
`;

(async function run() {
  const client = new Client({ connectionString: DATABASE_URL });
  try {
    await client.connect();
    console.log('Connected to DB. Running migration...');
    await client.query(sql);
    console.log('Migration executed. Table `public.submissions` created and RLS enabled.');
    console.log('Note: service_role key bypasses RLS. For client-side writes, create explicit policies as needed.');
  } catch (err) {
    console.error('Migration failed:', err);
  } finally {
    await client.end();
  }
})();
