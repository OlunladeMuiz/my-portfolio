# Local API for Contact Form

This project includes a simple Express API (`server.js`) that saves contact form submissions to `data/submissions.json`.

Quick setup

1. Install dependencies:

```bash
npm install
```

2. Start the API server (default port 3000):

```bash
npm start
```

3. (Optional) Expose your local API to the internet using `localtunnel`:

```bash
npm run tunnel -- --subdomain your-unique-subdomain
# example: npm run tunnel -- --subdomain my-portfolio-api
```

The command prints a public URL (https://your-unique-subdomain.loca.lt) — use that as the API origin.

Notes
- The client `script.js` now uses the page origin as the API URL when available, and falls back to `http://localhost:3000/api/users` for local development.
- Development note: if another process binds port 3000 (common if you run multiple local projects), start the API on port **3001** (for example: `PORT=3001 node server.js`) or stop the conflicting process; the client will probe ports 3000 and 3001 automatically.
- If you want to force a specific public URL, either host `server.js` on that domain, or set `API_URL` in `script.js` manually.

Security
- The GET `/api/users` route requires an admin token provided via header `x-admin-token` (see `server.js`).

Vercel Deployment (recommended for hosting frontend + serverless API)

Important: I can't use or accept account credentials on your behalf. Below are secure steps you can follow to deploy to Vercel and add persistent storage using Supabase.

1) Create a Vercel account and install the Vercel CLI, or sign in at https://vercel.com.

2) Prepare the project:

 - The repository root contains a serverless function at `api/users.js`. When deployed on Vercel, your contact form can post to `/api/users` on the same origin.

3) Persistent storage (choose one):

 - Supabase (recommended): create a Supabase project, add a table named `submissions` with columns `id` (bigint or bigint serial), `name`, `email`, `subject`, `message`, `receivedAt` (timestamp). Copy the `SUPABASE_URL` and `SUPABASE_KEY` (service role or anon key) and add them as Environment Variables on Vercel.
Security notes & Row Level Security (RLS):
 - After creating the `submissions` table, enable RLS to prevent public (anon) clients from reading/inserting directly.
 - Use the SQL in `supabase/migration.sql` to create the table and enable RLS.
 - If you want to allow authenticated client inserts, add explicit policies scoped to `auth.role() = 'authenticated'` or implement a server-based insert.
 - The serverless function uses `SUPABASE_KEY` (service role recommended) and should remain server-side only; do not expose this key client-side.

Migration & RLS steps (recommended):
 - In Supabase, open SQL editor and run `supabase/migration.sql`.
 - Optionally run `scripts/migrate-supabase.js` with `DATABASE_URL` set (admin access) to create the table and enable RLS programmatically.

 - Supabase (recommended): create a Supabase project, add a table named `submissions` with columns `id` (bigint or bigint serial), `name`, `email`, `subject`, `message`, `receivedAt` (timestamp). Copy the `SUPABASE_URL` and `SUPABASE_KEY` (service role or anon key) and add them as Environment Variables on Vercel.
	 - This repo defaults `SUPABASE_URL` to `https://fcilspmbkcwwfihxcgod.supabase.co`; you can override with `SUPABASE_URL` env var.
	 - Set `SUPABASE_KEY` in your environment to enable the serverless function to write/read submissions.

	Example SQL to create the `submissions` table in Supabase SQL editor:

	```sql
	create table public.submissions (
		id bigint generated by default as identity primary key,
		name text not null,
		email text not null,
		subject text not null,
		message text not null,
		receivedAt timestamptz not null default now()
	);
	```

	Example environment variable setup (Vercel):
	- `SUPABASE_URL`: https://fcilspmbkcwwfihxcgod.supabase.co
	- `SUPABASE_KEY`: <your-supabase-key>
	 - **SECURITY**: `SUPABASE_KEY` should be a service role key when used by the server or serverless functions. Do NOT expose it to client-side code or commit it to the repository. Use an anon key only if you configure strict RLS policies.
  
	Quick test (local):
	1. Copy `.env.example` to `.env` and update `SUPABASE_KEY`.
	2. Install dependencies if necessary: `npm install @supabase/supabase-js`.
	3. Run the test script:

	```bash
	SUPABASE_KEY=<your-supabase-key> node scripts/test-supabase.js
	```
 - SendGrid (email-only): set `SENDGRID_API_KEY` and `SENDGRID_TO` env vars on Vercel to receive email copies of submissions.
	- Note: This repo defaults `SENDGRID_TO` to muiz.olunlade.9@gmail.com if `SENDGRID_TO` is not set in environment variables. You can override it by setting `SENDGRID_TO` to your preferred recipient.

 - SMTP fallback: You can provide SMTP credentials instead of SendGrid by setting `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS` (and optionally `SMTP_SECURE` and `SMTP_FROM`) in Vercel environment variables. The serverless function will use SMTP to email submissions if SendGrid is not configured.

 - Temporary fallback: If no persistent storage or email service is configured, the serverless function will store incoming submissions in a temporary file (`/tmp/submissions.json`) on the server (ephemeral storage useful for debugging). This will allow the form to submit successfully, but **does not persist** across cold-starts or redeploys. For reliability, configure Supabase or an email provider.

Fallback verification script
- A small script `scripts/test-fallback.js` is included to automatically verify whether your deployed API is using a persistent backend or the temporary `/tmp` fallback.
- Usage (local test):

```bash
# default tests http://localhost:3000/api/users
npm run test:fallback

# target a deployed URL
API_URL=https://your-deployment.example.com/api/users npm run test:fallback
```

- CI integration: run the script in your pipeline. It exits with code `2` when the deployment accepted the submission but used the `tmp` fallback — a useful failure condition to alert you to configure persistence.
- Optional webhook notifications: you can provide `WEBHOOK_URL` (an HTTP endpoint that accepts JSON) as an environment variable. When the script detects `tmp` fallback it will POST a notification to that webhook with details.


4) Required Vercel environment variables (set in Project Settings → Environment Variables):

 - `SUPABASE_URL` (optional)
 - `SUPABASE_KEY` (optional)
 - `SENDGRID_API_KEY` (optional)
 - `SENDGRID_TO` (optional)
 - `ADMIN_TOKEN` (optional — used to protect GET /api/users)
 - `ALLOWED_ORIGIN` (optional — CORS origin, default `*`)

Security (REQUIRED for production):
- Set `ADMIN_TOKEN` to a strong secret — never use the default `changeme` value in production.
- Set `ALLOWED_ORIGIN` to your production domain (e.g. `https://yourdomain.com`) to restrict CORS.
- `SUPABASE_KEY` or `SENDGRID_API_KEY` must be set if you want persistence or email functionality. Do not expose keys in the client or commit to version control.

Migration & RLS (secure procedure):
 - The SQL in `supabase/migration.sql` creates the `submissions` table and enables RLS.
 - Decide whether you want clients to insert directly using an anon key — if so, configure an RLS policy that permits only authenticated users inserts (and ensure your frontend uses JWT auth).
 - Otherwise, keep the abilities server-only by using the Supabase service role key in the serverless `SUPABASE_KEY` env var which bypasses RLS.
 - If you prefer an automated migration, set `DATABASE_URL` to your Supabase Postgres connection string and run `node scripts/migrate-supabase.js` locally (use a service role or DB admin connection).

5) Deploy with Vercel CLI or Git integration:

```bash
# install vercel CLI
npm i -g vercel

# from project root
vercel login
vercel --prod
```

6) After deploy, your site origin will be the API origin; client `script.js` will post to `/api/users` automatically.

Security note: never paste account passwords or private keys into chat. Use the Vercel dashboard to add env vars.
# My Portfolio Contact API

This is a small Express API that accepts contact form submissions from a static portfolio site and saves them to a local JSON file. It is designed to be deployed to Heroku or any Node.js hosting provider.

Features:
- POST /api/users: Accepts { name, email, subject, message } and returns submission object.
- GET /api/users: Returns saved submissions (requires `x-admin-token` header matching `ADMIN_TOKEN`).

Run locally:
1. Install dependencies:
```bash
npm install
```
2. Start server:
```bash
npm start
```
3. Test with curl:
```bash
curl -X POST -H "Content-Type: application/json" -d '{"name":"Test","email":"a@b.com","subject":"Hello","message":"Hi"}' http://localhost:3000/api/users
```

Heroku deploy steps:
1. Login to Heroku: `heroku login`.
2. Create an app: `heroku create <your-app-name>`.
3. Push your code: `git push heroku main` (or `master` depending on branch).
4. Set environment vars:
```bash
heroku config:set ADMIN_TOKEN="your-secret-token" ALLOWED_ORIGIN="https://yourdomain.com"
```
If you want email notifications, set SendGrid variables:
```bash
heroku config:set SENDGRID_API_KEY="<your-sendgrid-key>" SENDGRID_TO="muiz.olunlade.9@gmail.com" SENDGRID_FROM="no-reply@yourdomain.com"
```
5. Visit your app: `heroku open` or test POST with `curl`.

Notes:
- By default submissions are saved to `data/submissions.json`. For scalability use a database (Postgres, MongoDB) or a third party mail service for notifications.
- For CORS, set `ALLOWED_ORIGIN` to your website domain.
- For production email sending, use SendGrid, Mailgun, or similar services and store API keys in environment variables.
